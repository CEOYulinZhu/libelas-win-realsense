# RealSense 实时闪烁问题排查

## 背景
- 问题仅出现在 RealSense 模式 `./elas realsense [w h fps]`，对应 `src/main.cpp:155-311` 的实时循环。
- 只在拍摄玻璃墙、深色墙体、布料等低纹理/高反射场景时出现闪烁，面对白墙时现象消失。
- 这类场景在红外段缺乏可匹配纹理，因此实时处理链路中的预处理方式会直接决定 ELAS 匹配的稳定性。

## 排查记录
- 核心库文件（`src/elas.cpp`, `src/filter.cpp`, `src/descriptor.cpp`, `src/matrix.cpp`, `src/triangle.cpp`）保持原始 ELAS 实现，仅对灰度缓冲区进行运算，不会对特定材质产生差异，因此排除。
- RealSense 路径中，帧经过极线校正后执行 `cv::equalizeHist` 与 `cv::GaussianBlur`，再传入 `Elas::process` (`src/main.cpp:216-224`)。此过程中没有额外的曝光/红外投射器调节逻辑，像素强度如何拉伸完全由 `equalizeHist` 决定。

## 根因
- `cv::equalizeHist` 在每帧、每个相机上独立调用（`src/main.cpp:216-217`），根据当帧完整直方图生成 LUT，并把输出映射到 `[0,255]`。
- 由于 LUT 对左右眼、不同帧都是独立计算，导致两个输入图像的光度映射既不同又快速变化，破坏了 ELAS 的亮度/梯度一致性假设。
- 在玻璃或深色材质上，红外直方图集中在少量灰度并伴随随机噪声。直方图均衡会把噪声与镜面高光放大成不同的伪纹理，`src/descriptor.cpp:27-35` 中的 Sobel 描述子因此在帧间剧烈变化，`Elas::process` 不断匹配到不同的噪声结构，表现为深度图闪烁。
- 白墙的直方图稳定且信噪比高，左右眼生成的 LUT 基本一致，匹配保持稳定，因此看不到问题。

## 建议
1. 删除当前的逐帧 `cv::equalizeHist`，或改为生成一个共享 LUT（例如只基于左眼或首帧）并在多帧/双眼之间复用；也可以使用 CLAHE，但必须让左右眼复用同一个表。
2. 提供选项让 RealSense 固件自行控制曝光/投射器，只在 CPU 侧做温和、固定的伽马或线性拉伸，避免破坏光度一致性。
3. 在预处理改为同步、缓变的映射后，`src/main.cpp:247-281` 已有的深度时间平滑才能真正压制剩余噪声，玻璃和暗色物体上的闪烁会大幅减轻。
