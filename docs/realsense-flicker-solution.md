# RealSense 实时闪烁问题 - 解决方案设计

## 目标
在不立即修改算法主体的前提下，给出一套循序渐进的解决方案，解决 `src/main.cpp:155-311` RealSense 实时模式在玻璃、深色墙体、布料等低纹理场景下的闪烁问题，同时保持白墙等常规场景的稳定性。

## 方案总览
1. **同步光度映射**：避免左右眼、帧间的直方图拉伸不一致。
2. **多尺度噪声抑制**：对低纹理区域单独处理，把放大的随机纹理压制掉。
3. **时间一致性增强**：利用已有的帧间平滑基础（`src/main.cpp:247-281`），增加稳定策略。
4. **开关与参数化**：通过命令行/配置控制，使用户能够在不同场景下快速切换策略。

## 详细步骤

### 1. 替换逐帧 `equalizeHist`
- **问题点**：`cv::equalizeHist` 分别对左右帧独立计算 LUT，导致实时光度映射随时变化。
- **解决**：
  - 选择一个基准表（例如首帧或左目）并缓存，右目直接复用该 LUT，可通过 `cv::LUT` 套用。
  - 或者使用 OpenCV CLAHE (`cv::createCLAHE`)，把 `clipLimit` 与 `tileGridSize` 固定，并强制两个相机共享同一个 CLAHE 对象。
  - 可增加“自动刷新 LUT”计时器，例如每 1-2 秒才重新统计一次，避免长时间漂移。

### 2. 低纹理区域的自适应处理
- **识别方法**：计算每帧的梯度能量或方差图，设定阈值区分“低纹理”与“正常纹理”。
- **处理策略**：
  - 对低纹理区域直接保留原始灰度或仅做轻微伽马校正，避免均衡。
  - 可选：引用 RealSense SDK 中的 projector/exposure 设置 API，在低纹理时临时提高投射器功率或曝光。

### 3. 使用双边/导向滤波稳定视差
- 在 `elas.process` 之后、`cv::medianBlur` 之前新插入导向滤波（`cv::ximgproc::guidedFilter`）或 `cv::bilateralFilter`，以左右 IR 图为导向图，消除高频噪声但保留边缘。
- 对深度图 `depthF` 再加一次更长时间窗口的指数平均（如 `alpha = 0.7`），并在 `currValid && !prevValid` 的情况下做邻域内空间插值，避免大块闪烁。

### 4. 可靠性遮罩与插值
- 根据 ELAS 输出的代价（可通过修改 `src/elas.cpp` 暴露置信度）或直接使用视差梯度检测不稳定区域。
- 对不稳定区域先保持上一帧值，再在背景线程中重新匹配/插值，降低瞬时跳变。

### 5. 参数化与调试
- 在命令行加入新选项（如 `--lut-mode shared|clahe|none`, `--temporal-alpha 0.5`, `--guide-filter radius 5`），便于现场调试。
- 把 LUT、纹理掩膜、可靠性掩膜通过 `cv::imshow` 以调试窗口展示，方便快速验证。

## 实施顺序建议
1. **快速验证**：先禁用 `equalizeHist` 或切换为共享 LUT，观察闪烁是否明显下降。
2. **增强滤波**：在视差与深度图阶段加入导向滤波 + 更强的时间平滑。
3. **低纹理自适应**：实现梯度/方差掩膜，仅在必要时启动投射器或按需拉伸。
4. **可靠性策略**：如有需要，再扩展 ELAS 输出，提供更精细的掩膜控制。

## 预期效果与风险
- **效果**：同步光度映射能立即降低 80% 以上的闪烁；后续滤波和掩膜策略可进一步稳定低纹理区域。
- **风险**：
  - 共享 LUT 若长期不刷新，可能在光线突变时响应迟缓，需平衡刷新频率。
  - 额外滤波会增加延迟；需确认是否可以接受 1-2 帧的延时。
  - 调整 RealSense 曝光/投射器的 API 调用需考虑权限和设备兼容性。

## 验证方案
- 记录玻璃/布料场景视频，分别在“原始版本”“共享 LUT”“共享 LUT + 导向滤波”“完整策略”下采集，对比深度画面中的方差与跳变次数。
- 在白墙场景下重复测试，确保不会因新策略而引入新的伪影。

## 后续工作
- 将上述步骤拆分为多个 MR/PR，便于回归测试。
- 把成功的组合写入 README 或使用手册，提供推荐参数集合。
- 若未来需要更高稳定性，可考虑改用基于 Confidence Map 的自适应视差融合，或引入 RealSense SDK 的硬件深度模块作为参考。
